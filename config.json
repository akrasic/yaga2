{
  "$schema": "./config.schema.json",
  "_comment": "Smartbox Anomaly Detection Configuration - All values can be overridden by environment variables",
  "victoria_metrics": {
    "endpoint": "https://otel-metrics.production.smartbox.com",
    "timeout_seconds": 10,
    "max_retries": 3,
    "pool_connections": 20,
    "pool_maxsize": 20,
    "circuit_breaker_threshold": 5,
    "circuit_breaker_timeout_seconds": 300,
    "retry_backoff_factor": 0.3,
    "retry_status_forcelist": [
      500,
      502,
      503,
      504
    ]
  },
  "observability_api": {
    "base_url": "http://localhost:8000",
    "anomalies_endpoint": "/api/anomalies/batch",
    "resolutions_endpoint": "/api/incidents/resolve",
    "request_timeout_seconds": 5,
    "enabled": true
  },
  "model": {
    "models_directory": "./smartbox_models/",
    "min_training_samples": 500,
    "min_multivariate_samples": 1000,
    "default_contamination": 0.05,
    "default_n_estimators": 200,
    "random_state": 42,
    "contamination_by_category": {
      "critical": 0.03,
      "standard": 0.05,
      "micro": 0.08,
      "admin": 0.06,
      "core": 0.04,
      "background": 0.08
    },
    "contamination_by_service": {
      "booking": 0.02,
      "search": 0.04,
      "mobile-api": 0.035,
      "shire-api": 0.03,
      "vms": 0.03,
      "friday": 0.05,
      "gambit": 0.05,
      "titan": 0.05,
      "r2d2": 0.05,
      "catalog": 0.05,
      "tc14": 0.05,
      "fa5": 0.08,
      "m2-fr-adm": 0.06,
      "m2-it-adm": 0.06,
      "m2-bb-adm": 0.06,
      "m2-bn-adm": 0.06,
      "m2-cb-adm": 0.06,
      "m2-ch-adm": 0.06,
      "m2-es-adm": 0.06,
      "m2-ez-adm": 0.06,
      "m2-lv-adm": 0.06,
      "m2-df-adm": 0.06,
      "m2-dk-adm": 0.06,
      "m2-se-adm": 0.06,
      "m2-bb": 0.04,
      "m2-bn": 0.04,
      "m2-cb": 0.04,
      "m2-ch": 0.04,
      "m2-ez": 0.04,
      "m2-fr": 0.04,
      "m2-it": 0.04,
      "m2-es": 0.04,
      "m2-df": 0.04,
      "m2-dk": 0.04,
      "m2-ds": 0.04,
      "m2-se": 0.04,
      "m2-lv": 0.04
    },
    "n_estimators_by_complexity": {
      "high": {
        "default": 250,
        "above_5k": 300,
        "above_10k": 400
      },
      "medium": {
        "default": 150,
        "above_3k": 200,
        "above_8k": 250
      },
      "low": {
        "default": 100,
        "above_5k": 150
      }
    }
  },
  "training": {
    "lookback_days": 60,
    "_comment_lookback": "Extended from 30 to 60 days to support dual-model training with excluded periods",
    "min_data_points": 2000,
    "validation_fraction": 0.2,
    "contamination_estimation": {
      "method": "knee",
      "min_samples": 100,
      "fallback": 0.05
    },
    "threshold_calibration": {
      "enabled": true,
      "percentiles": {
        "critical": 0.1,
        "high": 1,
        "medium": 5,
        "low": 10
      }
    },
    "drift_detection": {
      "enabled": false,
      "z_score_warning": 3,
      "z_score_critical": 5
    },
    "_comment_excluded": "Periods to exclude from baseline training (e.g., holidays with atypical traffic)",
    "excluded_periods": [
      {
        "start": "2025-12-01",
        "end": "2026-01-10",
        "reason": "christmas_new_year_holiday",
        "model_variant": "holiday"
      }
    ],
    "model_variants": {
      "_comment": "Dual-model architecture: baseline (normal periods) + holiday (excluded periods)",
      "train_baseline": true,
      "train_holiday": true,
      "min_excluded_days_for_variant": 7,
      "holiday_data_weight": 0.3
    }
  },
  "inference": {
    "alerts_directory": "./alerts/",
    "max_workers": 3,
    "inter_service_delay_seconds": 0.2,
    "check_drift": false
  },
  "fingerprinting": {
    "db_path": "./anomaly_state.db",
    "cleanup_max_age_hours": 72,
    "incident_separation_minutes": 30,
    "_comment_cycles": "Cycle-based incident lifecycle settings (inference runs every 2-3 min)",
    "confirmation_cycles": 2,
    "resolution_grace_cycles": 3
  },
  "time_periods": {
    "_comment": "3-period model: time-of-day buckets covering all 7 days (no weekend split)",
    "business_hours": {
      "start": 8,
      "end": 18,
      "_comment": "Day hours 8-18, all days"
    },
    "evening_hours": {
      "start": 18,
      "end": 22,
      "_comment": "Transition period 18-22, all days"
    },
    "night_hours": {
      "start": 22,
      "end": 8,
      "_comment": "Overnight 22-8, all days"
    },
    "min_samples": {
      "_comment": "With 3-period model, all periods have similar data volume",
      "critical": 200,
      "standard": 200,
      "admin": 150,
      "micro": 100
    },
    "confidence_scores": {
      "business_hours": 0.9,
      "evening_hours": 0.85,
      "night_hours": 0.8
    },
    "validation_thresholds": {
      "_comment": "With more data per period, we can use stricter thresholds",
      "business_hours": 0.22,
      "evening_hours": 0.28,
      "night_hours": 0.4
    }
  },
  "detection_thresholds": {
    "severity_scores": {
      "critical": -0.6,
      "high": -0.3,
      "medium": -0.1
    },
    "error_rates": {
      "critical": 0.05,
      "high": 0.02,
      "very_high": 0.2
    },
    "latency_ms": {
      "critical": 2000,
      "high": 1000
    },
    "ratios": {
      "dependency_latency_bottleneck": 0.6,
      "database_latency_bottleneck": 0.7,
      "traffic_cliff_threshold": 0.3
    },
    "outlier_percentiles": {
      "lower": 0.001,
      "upper": 0.999
    },
    "validation": {
      "max_request_rate": 1000000,
      "max_latency_ms": 300000,
      "constant_value_threshold": 1e-10
    }
  },
  "services": {
    "critical": [
      "booking",
      "search",
      "mobile-api",
      "shire-api",
      "vms"
    ],
    "standard": [
      "friday",
      "gambit",
      "titan",
      "r2d2",
      "catalog",
      "tc14"
    ],
    "micro": [
      "fa5"
    ],
    "admin": [
      "m2-fr-adm",
      "m2-it-adm",
      "m2-bb-adm",
      "m2-bn-adm",
      "m2-cb-adm",
      "m2-ch-adm",
      "m2-es-adm",
      "m2-ez-adm",
      "m2-lv-adm",
      "m2-df-adm",
      "m2-dk-adm",
      "m2-se-adm"
    ],
    "core": [
      "m2-bb",
      "m2-bn",
      "m2-cb",
      "m2-ch",
      "m2-ez",
      "m2-fr",
      "m2-it",
      "m2-es",
      "m2-df",
      "m2-dk",
      "m2-ds",
      "m2-se",
      "m2-lv"
    ],
    "pattern_detection": {
      "api_patterns": [
        "api",
        "gateway",
        "proxy"
      ],
      "admin_patterns": [
        "admin",
        "adm",
        "mgmt"
      ],
      "background_patterns": [
        "worker",
        "job",
        "task",
        "queue"
      ],
      "micro_patterns": [
        "micro",
        "util",
        "helper"
      ],
      "core_patterns": [
        "m2-",
        "core",
        "platform"
      ]
    }
  },
  "dependencies": {
    "_comment": "Service dependency graph for cascade detection. Each service lists the services it calls.",
    "graph": {
      "mobile-api": [
        "vms"
      ],
      "booking": [
        "search",
        "vms",
        "r2d2",
        "friday"
      ],
      "search": [
        "catalog",
        "r2d2"
      ],
      "shire-api": [
        "vms"
      ],
      "vms": [],
      "gambit": [
        "vms"
      ],
      "friday": [],
      "titan": [],
      "r2d2": [
        "catalog"
      ],
      "catalog": [],
      "fa5": [],
      "tc14": [
        "r2d2"
      ]
    },
    "cascade_detection": {
      "enabled": true,
      "max_depth": 5,
      "latency_propagation_threshold": 0.6,
      "require_temporal_correlation": true,
      "correlation_window_minutes": 5
    }
  },
  "slos": {
    "_comment": "SLO-aware severity evaluation. Adjusts ML-detected severity based on operational thresholds.",
    "enabled": true,
    "allow_downgrade_to_informational": true,
    "require_slo_breach_for_critical": true,
    "defaults": {
      "_comment": "Default thresholds applied to services without specific SLOs",
      "latency_acceptable_ms": 500,
      "latency_warning_ms": 800,
      "latency_critical_ms": 1000,
      "error_rate_acceptable": 0.005,
      "error_rate_warning": 0.01,
      "error_rate_critical": 0.02,
      "_comment_error_floor": "Error rate floor - below this, suppress anomaly entirely (0 = use acceptable)",
      "error_rate_floor": 0,
      "min_traffic_rps": 1,
      "busy_period_factor": 1.5,
      "_comment_db_latency": "Database latency evaluation - uses ratio from baseline (training mean)",
      "database_latency_floor_ms": 1,
      "database_latency_ratios": {
        "_comment": "Multipliers of baseline: 1.5x=info, 2x=warning, 3x=high, 5x=critical",
        "info": 1.5,
        "warning": 2,
        "high": 3,
        "critical": 5
      },
      "_comment_request_rate": "Request rate evaluation - surges vs cliffs with correlation-based severity",
      "request_rate_evaluation": {
        "enabled": true,
        "_comment_surge": "Traffic surge: informational unless causing other SLO breaches",
        "surge": {
          "threshold_percent": 200,
          "standalone_severity": "informational",
          "with_latency_breach_severity": "warning",
          "with_error_breach_severity": "high"
        },
        "_comment_cliff": "Traffic cliff: warning by default - often indicates real problems",
        "cliff": {
          "threshold_percent": 50,
          "standalone_severity": "warning",
          "peak_hours_severity": "high",
          "with_upstream_errors_severity": "critical"
        },
        "_comment_min_expected": "Minimum expected traffic by time period (rps) - 3-period model",
        "min_expected_rps": {
          "business_hours": 5,
          "evening_hours": 2,
          "night_hours": 0.5
        }
      }
    },
    "services": {
      "booking": {
        "_comment": "Critical booking service - stricter thresholds",
        "latency_acceptable_ms": 300,
        "latency_warning_ms": 400,
        "latency_critical_ms": 500,
        "error_rate_acceptable": 0.002,
        "error_rate_warning": 0.005,
        "error_rate_critical": 0.01,
        "_comment_error_floor": "Suppress error alerts below 0.2% - eliminates noise from tiny deviations",
        "error_rate_floor": 0.002,
        "database_latency_floor_ms": 0.5,
        "request_rate_evaluation": {
          "cliff": {
            "standalone_severity": "high",
            "peak_hours_severity": "critical"
          },
          "min_expected_rps": {
            "business_hours": 20,
            "evening_hours": 10,
            "night_hours": 2
          }
        }
      },
      "search": {
        "_comment": "Search must be fast",
        "latency_acceptable_ms": 200,
        "latency_warning_ms": 350,
        "latency_critical_ms": 500,
        "error_rate_acceptable": 0.005,
        "error_rate_warning": 0.01,
        "error_rate_critical": 0.02,
        "database_latency_floor_ms": 0.3,
        "database_latency_ratios": {
          "info": 1.3,
          "warning": 1.5,
          "high": 2,
          "critical": 3
        }
      },
      "mobile-api": {
        "_comment": "Mobile API - user-facing, moderate latency acceptable",
        "latency_acceptable_ms": 400,
        "latency_warning_ms": 600,
        "latency_critical_ms": 800,
        "error_rate_acceptable": 0.003,
        "error_rate_warning": 0.008,
        "error_rate_critical": 0.015
      },
      "vms": {
        "_comment": "VMS backend - can tolerate higher latency",
        "latency_acceptable_ms": 800,
        "latency_warning_ms": 1200,
        "latency_critical_ms": 2000,
        "error_rate_acceptable": 0.01,
        "error_rate_warning": 0.02,
        "error_rate_critical": 0.05,
        "database_latency_floor_ms": 5
      }
    },
    "busy_periods": [
      {
        "_comment": "Holiday season - thresholds relaxed by busy_period_factor",
        "start": "2025-12-01T00:00:00",
        "end": "2026-01-10T23:59:59"
      }
    ]
  },
  "alerting": {
    "_comment": "Alert filtering and correlation settings - controls which anomalies are sent to Web API",
    "severity_threshold": "low",
    "_comment_severity": "Only anomalies at or above this severity are sent to API (low/medium/high/critical)",
    "log_below_threshold": true,
    "below_threshold_log_level": "INFO",
    "_comment_non_alerting": "Patterns that are logged but never sent to API (healthy indicators)",
    "non_alerting_patterns": [
      "request_rate_surge_healthy"
    ],
    "correlation": {
      "_comment": "Group multiple anomalies for same service into single incident",
      "enabled": false,
      "window_seconds": 300,
      "primary_selection": "highest_confidence",
      "min_anomalies_to_correlate": 2
    }
  },
  "logging": {
    "level": "INFO",
    "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  },
  "envoy_enrichment": {
    "_comment": "Envoy edge/ingress metrics enrichment - adds edge-level context to anomaly alerts",
    "enabled": true,
    "mimir_endpoint": "https://mimir.sbxtest.net/prometheus",
    "lookback_minutes": 5,
    "timeout_seconds": 10,
    "_comment_mapping": "OTel service name to Envoy cluster name mapping",
    "cluster_mapping": {
      "booking": "booking",
      "search": "search_k8s",
      "mobile-api": "mobile-api",
      "shire-api": "shireapi_cluster",
      "fa5": "fa5-public",
      "titan": "titan",
      "friday": "friday"
    }
  }
}